#!/usr/bin/env perl

use strict;
use warnings;

our $delimiter = qr/(?:\s+|,)/;
our $input_type = 'f';
our $offset = 0;
our $prefix = 0;

use Getopt::Long;
Getopt::Long::Configure ("bundling");
GetOptions
  '-f'   => sub { $input_type = 'f' },
  '-p'   => sub { $input_type = 'p' },
  '-o=i' => sub { $offset = int($_[1]) },
  '-d=s' => sub { $delimiter = qr/$_[1]/ },
  '-P:s' => sub { $prefix = $_[1] ? qr/^$_[1]/ : 1 },
or exit(1);

$prefix = qr/^.*?$delimiter/ if $prefix == 1;

use Socket q[inet_aton];

if ($input_type eq 'f') {
  while (<>) {
    s/$prefix// if $prefix;
    my ($flow,$proto,$src,$dst,$sport,$dport) = split /(?:\s+|,)/;
    goto packets if $proto == 0 or $proto > 255;
    $src = inet_aton $src;
    $dst = inet_aton $dst;
    print(pack('ca4a4nn',$proto,$src,$dst,$sport,$dport));
  }
} elsif ($input_type eq 'p') {
  while (<>) {
    s/$prefix// if $prefix;
packets:
    my ($flow,$time,$size) = split /(?:\s+|,)/;
    my $sec  = int($time);
    my $usec = int(($time-$sec)*1e6);
    print(pack('NNNn',$flow-$offset,$sec,$usec,$size));
  }
}
